<!DOCTYPE html>
<html lang="en-GB" dir="ltr" class="client-nojs">

<!-- Mirrored from wiki.hellground.net/index.php/Tutorial:Fix_8033 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 Apr 2016 10:50:53 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<title>Tutorial:Fix 8033 - HellGroundCore MMORPG framework educational and hobby project</title>
<meta charset="UTF-8" />
<meta name="generator" content="MediaWiki 1.21.4" />
<link rel="shortcut icon" href="http://wiki.hellground.net/favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="http://wiki.hellground.net/opensearch_desc.php" title="HellGroundCore MMORPG framework educational and hobby project (en-gb)" />
<link rel="EditURI" type="application/rsd+xml" href="http://wiki.hellground.net/api.php?action=rsd" />
<link rel="alternate" type="application/atom+xml" title="HellGroundCore MMORPG framework educational and hobby project Atom feed" href="http://wiki.hellground.net/index.php?title=Special:RecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="http://wiki.hellground.net/load.php?debug=false&amp;lang=en-gb&amp;modules=mediawiki.legacy.commonPrint%2Cshared%7Cskins.vector&amp;only=styles&amp;skin=vector&amp;*" />
<meta name="ResourceLoaderDynamicStyles" content="" />
<style>a:lang(ar),a:lang(ckb),a:lang(fa),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: admin_wikia:resourceloader:filter:minify-css:7:584a0492c58c82e3a4daddd5656471fb */</style>

<script src="http://wiki.hellground.net/load.php?debug=false&amp;lang=en-gb&amp;modules=startup&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Tutorial:Fix_8033","wgTitle":"Tutorial:Fix 8033","wgCurRevisionId":1167,"wgArticleId":292,"wgIsArticle":true,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Fixing tutorials","Fixing tutorials (easy)"],"wgBreakFrames":false,"wgPageContentLanguage":"en-gb","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Tutorial:Fix_8033","wgRestrictionEdit":[],"wgRestrictionMove":[]});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function(){mw.user.options.set({"ccmeonemails":0,"cols":80,"date":"default","diffonly":0,"disablemail":0,"disablesuggest":0,"editfont":"default","editondblclick":0,"editsection":1,"editsectiononrightclick":0,"enotifminoredits":0,"enotifrevealaddr":0,"enotifusertalkpages":1,"enotifwatchlistpages":0,"extendwatchlist":0,"externaldiff":0,"externaleditor":0,"fancysig":0,"forceeditsummary":0,"gender":"unknown","hideminor":0,"hidepatrolled":0,"imagesize":2,"justify":0,"math":1,"minordefault":0,"newpageshidepatrolled":0,"nocache":0,"noconvertlink":0,"norollbackdiff":0,"numberheadings":0,"previewonfirst":0,"previewontop":1,"quickbar":5,"rcdays":7,"rclimit":50,"rememberpassword":0,"rows":25,"searchlimit":20,"showhiddencats":0,"showjumplinks":1,"shownumberswatching":1,"showtoc":1,"showtoolbar":1,"skin":"vector","stubthreshold":0,"thumbsize":2,"underline":2,"uselivepreview":0,"usenewrc":0,"watchcreations":0,"watchdefault":0,"watchdeletion":0,"watchlistdays":3,
"watchlisthideanons":0,"watchlisthidebots":0,"watchlisthideliu":0,"watchlisthideminor":0,"watchlisthideown":0,"watchlisthidepatrolled":0,"watchmoves":0,"wllimit":250,"variant":"en-gb","language":"en-gb","searchNs0":true,"searchNs1":false,"searchNs2":false,"searchNs3":false,"searchNs4":false,"searchNs5":false,"searchNs6":false,"searchNs7":false,"searchNs8":false,"searchNs9":false,"searchNs10":false,"searchNs11":false,"searchNs12":false,"searchNs13":false,"searchNs14":false,"searchNs15":false});;},{},{});mw.loader.implement("user.tokens",function(){mw.user.tokens.set({"editToken":"+\\","patrolToken":false,"watchToken":false});;},{},{});
/* cache key: admin_wikia:resourceloader:filter:minify-js:7:811a3adb8f714f1f28210df16d324ee9 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax"]);
}</script>
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/skins/vector/csshover.min.htc")}</style><![endif]--></head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Tutorial_Fix_8033 skin-vector action-view vector-animateLayout">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<!-- content -->
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>
			<div id="mw-js-message" style="display:none;"></div>
						<!-- firstHeading -->
			<h1 id="firstHeading" class="firstHeading" lang="en-gb"><span dir="auto">Tutorial:Fix 8033</span></h1>
			<!-- /firstHeading -->
			<!-- bodyContent -->
			<div id="bodyContent">
								<!-- tagline -->
				<div id="siteSub">From HellGroundCore MMORPG framework educational and hobby project</div>
				<!-- /tagline -->
								<!-- subtitle -->
				<div id="contentSub"></div>
				<!-- /subtitle -->
																<!-- jumpto -->
				<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="#mw-navigation">navigation</a>, 					<a href="#p-search">search</a>
				</div>
				<!-- /jumpto -->
								<!-- bodycontent -->
				<div id="mw-content-text" lang="en-GB" dir="ltr" class="mw-content-ltr"><div class="toc" style="float: right; margin-left: 1em; margin-bottom: 1em; padding: 0">
<table style="width: 250px; margin: 0; border: 0 none">

<tr>
<td colspan="2" style="color: white; text-align: center; background-color: #DB9100;">
<p><span style="font-size: 120%"><b>Fix tutorial</b></span><br />
Lady Vashj - yell spam after death
</p>
</td></tr>
<tr>
<td width="60">Revision: </td>
<td> 8033
</td></tr>
<tr>
<td> Issue: </td>
<td> #000229
</td></tr>
<tr>
<td> Difficulty: </td>
<td> <a href="Category_Fixing_tutorials_(easy).html" title="Category:Fixing tutorials (easy)">easy</a>
</td></tr>
<tr>
<td> Category: </td>
<td> Scripts
</td></tr></table></div>
<p><b>Problem:</b> After death, <a rel="nofollow" class="external text" href="http://db.hellground.net/?npc=21212">Lady Vashj</a> was spamming with yell emotes.
</p>
<h2> <span class="mw-headline" id="Step-by-step_solving">Step-by-step solving</span></h2>
<p><b>Step 0:</b> Not much to do before starting, at most checking if report is true (She was freakin screaming all the time so yep, report was true)
</p><p><b>Step 1:</b> All boss' scripts are sorted so we easily find our Lady in <a rel="nofollow" class="external text" href="https://bitbucket.org/_hellground/hellground-core/src/default/src/scripts/scripts/Outland/coilfang_resevoir/serpent_shrine/boss_lady_vashj.cpp"><i>boss_lady_vashj.cpp</i></a>
</p><p><b>Step 2:</b> From bug report we know that emotes she uses are the ones supposed to be yelled on aggro, so we easily guess that our emote ID's are the ones defined as <code>SAY_AGGRO_1 ... SAY_AGGRO_4</code> (we can of course check it in database); We search boss' script looking for any appearance of them, we get only one match in <code>boss_lady_vashjAI::StartEvent()</code>.
</p><p><b>Step 3:</b> Yelling when starting event sounds OK, so we need to check when is <code>StartEvent()</code> called; we have two matches.
</p><p><b>Step 3a:</b> <code>StartEvent()</code> is called in <code>EnterCombat(Unit* who)</code>. It would be strange for dead Vashj to enter combat so this one is less likely to happen, we leave it for now, maybe second try will be more promising.
</p><p><b>Step 3b</b> <code>StartEvent()</code> is called in <code>MoveInLineOfSight(Unit* who)</code>. Well now we're going somewhere, each time someone moves near Vashj this function is called, it is also called if NPC is dead, so there should be a check for being dead.
</p><p><b>Step 4:</b> We take a look on our code:
</p>
<pre>
void MoveInLineOfSight(Unit *who)
{
    if (!Intro)
    {
        Intro = true;
        DoScriptText(SAY_INTRO, me);
    }
    if (!CanAttack)
        return;

    if (!who || me-&gt;getVictim())
        return;

    if (who-&gt;isTargetableForAttack() &amp;&amp; who-&gt;isInAccessiblePlacefor(me) &amp;&amp; me-&gt;IsHostileTo(who))
    {
        float attackRadius = me-&gt;GetAttackDistance(who);
        if (me-&gt;IsWithinDistInMap(who, attackRadius) &amp;&amp;
            me-&gt;GetDistanceZ(who) &lt;= CREATURE_Z_ATTACK_RANGE &amp;&amp;
            me-&gt;IsWithinLOSInMap(who))
        {
            if(Phase&#160;!= 2)
                AttackStart(who);

            if(!me-&gt;isInCombat())
                StartEvent();
        }
    }
}
</pre>
<p>before calling <code>StartEvent()</code> there are few checks for things like <code>CanAttack</code> or <code>who-&gt;isTargetableForAttack()</code>; We can search those functions looking for any dead check, but we can also add a check ourselves and see if it helps.
</p><p><b>Step 5:</b> We add a check for NPC being dead,
</p>
<pre>if(isDead()) return;</pre>
<p>"Where?"-You may ask. Well, answer is anywhere (in this function of course) we are now just trying to solve a problem so it does not necessarily be perfect for now. But basicaly we add simplest checks first, so lets place it for example at beginning. Now we compile our core and check it up.
</p>
<h2> <span class="mw-headline" id="Summary">Summary</span></h2>
<p>Adding check seems to fix problem, so we can simply commit it. We can also try to find a better way to do it, for example <code>if (!CanAttack) return; if (isDead()) return;</code> can be written as <code>if (!CanAttack || isDead()) return;</code>.
Other possibility is to set <code>CanAttack</code> to false when dying, but this will require further investigation about what <code>CanAttack</code> is used for; when, why is it changed and if it is even possible to simply use this value.
</p>
<!-- 
NewPP limit report
Preprocessor visited node count: 64/1000000
Preprocessor generated node count: 242/1000000
Post‐expand include size: 766/2097152 bytes
Template argument size: 178/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key admin_wikia:pcache:idhash:292-0!*!0!!*!*!* and timestamp 20160412104829 -->
</div>				<!-- /bodycontent -->
								<!-- printfooter -->
				<div class="printfooter">
				Retrieved from ‘<a href="http://wiki.hellground.net/index.php?title=Tutorial:Fix_8033&amp;oldid=1167">http://wiki.hellground.net/index.php?title=Tutorial:Fix_8033&amp;oldid=1167</a>’				</div>
				<!-- /printfooter -->
												<!-- catlinks -->
				<div id='catlinks' class='catlinks'><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="Special_Categories.html" title="Special:Categories">Categories</a>: <ul><li><a href="Category_Fixing_tutorials.html" title="Category:Fixing tutorials">Fixing tutorials</a></li><li><a href="Category_Fixing_tutorials_(easy).html" title="Category:Fixing tutorials (easy)">Fixing tutorials (easy)</a></li></ul></div></div>				<!-- /catlinks -->
												<div class="visualClear"></div>
				<!-- debughtml -->
								<!-- /debughtml -->
			</div>
			<!-- /bodyContent -->
		</div>
		<!-- /content -->
		<div id="mw-navigation">
			<h2>Navigation menu</h2>
			<!-- header -->
			<div id="mw-head">
				
<!-- 0 -->
<div id="p-personal" role="navigation" class="">
	<h3>Personal tools</h3>
	<ul>
<li id="pt-login"><a href="http://wiki.hellground.net/index.php?title=Special:UserLogin&amp;returnto=Tutorial%3AFix+8033" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>	</ul>
</div>

<!-- /0 -->
				<div id="left-navigation">
					
<!-- 0 -->
<div id="p-namespaces" role="navigation" class="vectorTabs">
	<h3>Namespaces</h3>
	<ul>
					<li  id="ca-nstab-main" class="selected"><span><a href="Tutorial_Fix_8033.html"  title="View the content page [c]" accesskey="c">Page</a></span></li>
					<li  id="ca-talk" class="new"><span><a href="http://wiki.hellground.net/index.php?title=Talk:Tutorial:Fix_8033&amp;action=edit&amp;redlink=1"  title="Discussion about the content page [t]" accesskey="t">Discussion</a></span></li>
			</ul>
</div>

<!-- /0 -->

<!-- 1 -->
<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet">
	<h3 id="mw-vector-current-variant">
		</h3>
	<h3><span>Variants</span><a href="#"></a></h3>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>

<!-- /1 -->
				</div>
				<div id="right-navigation">
					
<!-- 0 -->
<div id="p-views" role="navigation" class="vectorTabs">
	<h3>Views</h3>
	<ul>
					<li id="ca-view" class="selected"><span><a href="Tutorial_Fix_8033.html" >Read</a></span></li>
					<li id="ca-viewsource"><span><a href="http://wiki.hellground.net/index.php?title=Tutorial:Fix_8033&amp;action=edit"  title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span></li>
					<li id="ca-history" class="collapsible"><span><a href="http://wiki.hellground.net/index.php?title=Tutorial:Fix_8033&amp;action=history"  title="Past revisions of this page [h]" accesskey="h">View history</a></span></li>
			</ul>
</div>

<!-- /0 -->

<!-- 1 -->
<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet">
	<h3><span>Actions</span><a href="#"></a></h3>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>

<!-- /1 -->

<!-- 2 -->


<!-- /2 -->
				</div>
			</div>
			<!-- /header -->
			<!-- panel -->
			<div id="mw-panel">
				<!-- logo -->
					<div id="p-logo" role="banner"><a style="background-image: url(../skins/common/images/wiki.png);" href="Main_Page.html"  title="Visit the main page"></a></div>
				<!-- /logo -->
				
<!-- navigation -->
<div class="portal" role="navigation" id='p-navigation'>
	<h3>Navigation</h3>
	<div class="body">
		<ul>
			<li id="n-mainpage-description"><a href="Main_Page.html" title="Visit the main page [z]" accesskey="z">Main page</a></li>
			<li id="n-randompage"><a href="Spell_required.html" title="Load a random page [x]" accesskey="x">Random page</a></li>
		</ul>
	</div>
</div>

<!-- /navigation -->

<!-- HellGroundCore -->
<div class="portal" role="navigation" id='p-HellGroundCore'>
	<h3>HellGroundCore</h3>
	<div class="body">
		<ul>
			<li id="n-Project-site"><a href="https://hellground.net/" rel="nofollow">Project site</a></li>
			<li id="n-Project--forum"><a href="http://forum.hellground.net/" rel="nofollow">Project  forum</a></li>
			<li id="n-Project-repositories"><a href="http://emu.hellground.net/" rel="nofollow">Project repositories</a></li>
			<li id="n-Project-bug-tracker"><a href="http://forum.hellground.net/" rel="nofollow">Project bug tracker</a></li>
		</ul>
	</div>
</div>

<!-- /HellGroundCore -->

<!-- SEARCH -->

<!-- /SEARCH -->

<!-- TOOLBOX -->
<div class="portal" role="navigation" id='p-tb'>
	<h3>Tools</h3>
	<div class="body">
		<ul>
			<li id="t-whatlinkshere"><a href="Special_WhatLinksHere/Tutorial_Fix_8033.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
			<li id="t-recentchangeslinked"><a href="Special_RecentChangesLinked/Tutorial_Fix_8033.html" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
			<li id="t-specialpages"><a href="Special_SpecialPages.html" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
			<li id="t-print"><a href="http://wiki.hellground.net/index.php?title=Tutorial:Fix_8033&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li>
			<li id="t-permalink"><a href="http://wiki.hellground.net/index.php?title=Tutorial:Fix_8033&amp;oldid=1167" title="Permanent link to this revision of the page">Permanent link</a></li>
			<li id="t-info"><a href="http://wiki.hellground.net/index.php?title=Tutorial:Fix_8033&amp;action=info">Page information</a></li>
		</ul>
	</div>
</div>

<!-- /TOOLBOX -->

<!-- LANGUAGES -->

<!-- /LANGUAGES -->
			</div>
			<!-- /panel -->
		</div>
		<!-- footer -->
		<div id="footer" role="contentinfo">
							<ul id="footer-info">
											<li id="footer-info-lastmod"> This page was last modified on 4 June 2014, at 14:51.</li>
											<li id="footer-info-viewcount">This page has been accessed 421 times.</li>
									</ul>
							<ul id="footer-places">
											<li id="footer-places-privacy"><a href="TBC_HellGroundCore_Privacy_policy.html" title="TBC HellGroundCore:Privacy policy">Privacy policy</a></li>
											<li id="footer-places-about"><a href="TBC_HellGroundCore_About.html" title="TBC HellGroundCore:About">About HellGroundCore MMORPG framework educational and hobby project</a></li>
											<li id="footer-places-disclaimer"><a href="TBC_HellGroundCore_General_disclaimer.html" title="TBC HellGroundCore:General disclaimer">Disclaimers</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
					<li id="footer-poweredbyico">
						<a href="http://www.mediawiki.org/"><img src="../skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" width="88" height="31" /></a>
					</li>
				</ul>
						<div style="clear:both"></div>
		</div>
		<!-- /footer -->
		<script>if(window.mw){
mw.loader.state({"site":"loading","user":"missing","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.action.view.postEdit","mediawiki.user","mediawiki.page.ready","mediawiki.searchSuggest","mediawiki.hidpi","skins.vector.js"], null, true);
}</script>
<script>if(window.mw){
mw.loader.state({"site":"ready"});
}</script>
<!-- Served in 0.087 secs. -->
	</body>

<!-- Mirrored from wiki.hellground.net/index.php/Tutorial:Fix_8033 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 Apr 2016 10:50:53 GMT -->
</html>

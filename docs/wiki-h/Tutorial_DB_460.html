<!DOCTYPE html>
<html lang="en-GB" dir="ltr" class="client-nojs">

<!-- Mirrored from wiki.hellground.net/index.php/Tutorial:DB_460 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 Apr 2016 10:50:52 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<title>Tutorial:DB 460 - HellGroundCore MMORPG framework educational and hobby project</title>
<meta charset="UTF-8" />
<meta name="generator" content="MediaWiki 1.21.4" />
<link rel="shortcut icon" href="http://wiki.hellground.net/favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="http://wiki.hellground.net/opensearch_desc.php" title="HellGroundCore MMORPG framework educational and hobby project (en-gb)" />
<link rel="EditURI" type="application/rsd+xml" href="http://wiki.hellground.net/api.php?action=rsd" />
<link rel="alternate" type="application/atom+xml" title="HellGroundCore MMORPG framework educational and hobby project Atom feed" href="http://wiki.hellground.net/index.php?title=Special:RecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="http://wiki.hellground.net/load.php?debug=false&amp;lang=en-gb&amp;modules=mediawiki.legacy.commonPrint%2Cshared%7Cskins.vector&amp;only=styles&amp;skin=vector&amp;*" />
<meta name="ResourceLoaderDynamicStyles" content="" />
<style>a:lang(ar),a:lang(ckb),a:lang(fa),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: admin_wikia:resourceloader:filter:minify-css:7:584a0492c58c82e3a4daddd5656471fb */</style>

<script src="http://wiki.hellground.net/load.php?debug=false&amp;lang=en-gb&amp;modules=startup&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Tutorial:DB_460","wgTitle":"Tutorial:DB 460","wgCurRevisionId":1130,"wgArticleId":298,"wgIsArticle":true,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Fixing tutorials","Fixing tutorials (medium)"],"wgBreakFrames":false,"wgPageContentLanguage":"en-gb","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Tutorial:DB_460","wgRestrictionEdit":[],"wgRestrictionMove":[]});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function(){mw.user.options.set({"ccmeonemails":0,"cols":80,"date":"default","diffonly":0,"disablemail":0,"disablesuggest":0,"editfont":"default","editondblclick":0,"editsection":1,"editsectiononrightclick":0,"enotifminoredits":0,"enotifrevealaddr":0,"enotifusertalkpages":1,"enotifwatchlistpages":0,"extendwatchlist":0,"externaldiff":0,"externaleditor":0,"fancysig":0,"forceeditsummary":0,"gender":"unknown","hideminor":0,"hidepatrolled":0,"imagesize":2,"justify":0,"math":1,"minordefault":0,"newpageshidepatrolled":0,"nocache":0,"noconvertlink":0,"norollbackdiff":0,"numberheadings":0,"previewonfirst":0,"previewontop":1,"quickbar":5,"rcdays":7,"rclimit":50,"rememberpassword":0,"rows":25,"searchlimit":20,"showhiddencats":0,"showjumplinks":1,"shownumberswatching":1,"showtoc":1,"showtoolbar":1,"skin":"vector","stubthreshold":0,"thumbsize":2,"underline":2,"uselivepreview":0,"usenewrc":0,"watchcreations":0,"watchdefault":0,"watchdeletion":0,"watchlistdays":3,
"watchlisthideanons":0,"watchlisthidebots":0,"watchlisthideliu":0,"watchlisthideminor":0,"watchlisthideown":0,"watchlisthidepatrolled":0,"watchmoves":0,"wllimit":250,"variant":"en-gb","language":"en-gb","searchNs0":true,"searchNs1":false,"searchNs2":false,"searchNs3":false,"searchNs4":false,"searchNs5":false,"searchNs6":false,"searchNs7":false,"searchNs8":false,"searchNs9":false,"searchNs10":false,"searchNs11":false,"searchNs12":false,"searchNs13":false,"searchNs14":false,"searchNs15":false});;},{},{});mw.loader.implement("user.tokens",function(){mw.user.tokens.set({"editToken":"+\\","patrolToken":false,"watchToken":false});;},{},{});
/* cache key: admin_wikia:resourceloader:filter:minify-js:7:811a3adb8f714f1f28210df16d324ee9 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax"]);
}</script>
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/skins/vector/csshover.min.htc")}</style><![endif]--></head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Tutorial_DB_460 skin-vector action-view vector-animateLayout">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<!-- content -->
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>
			<div id="mw-js-message" style="display:none;"></div>
						<!-- firstHeading -->
			<h1 id="firstHeading" class="firstHeading" lang="en-gb"><span dir="auto">Tutorial:DB 460</span></h1>
			<!-- /firstHeading -->
			<!-- bodyContent -->
			<div id="bodyContent">
								<!-- tagline -->
				<div id="siteSub">From HellGroundCore MMORPG framework educational and hobby project</div>
				<!-- /tagline -->
								<!-- subtitle -->
				<div id="contentSub"></div>
				<!-- /subtitle -->
																<!-- jumpto -->
				<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="#mw-navigation">navigation</a>, 					<a href="#p-search">search</a>
				</div>
				<!-- /jumpto -->
								<!-- bodycontent -->
				<div id="mw-content-text" lang="en-GB" dir="ltr" class="mw-content-ltr"><div class="toc" style="float: right; margin-left: 1em; margin-bottom: 1em; padding: 0">
<table style="width: 250px; margin: 0; border: 0 none">

<tr>
<td colspan="2" style="color: white; text-align: center; background-color: #DB9100;">
<p><span style="font-size: 120%"><b>Fix tutorial</b></span><br />
Refreshing mist
</p>
</td></tr>
<tr>
<td width="60">Revision: </td>
<td> DB 460
</td></tr>
<tr>
<td> Issue: </td>
<td> #000219
</td></tr>
<tr>
<td> Difficulty: </td>
<td> <a href="Category_Fixing_tutorials_(medium).html" title="Category:Fixing tutorials (medium)">medium</a>
</td></tr>
<tr>
<td> Category: </td>
<td> NPC
</td></tr></table></div>
<p><b>Problem:</b> After <a rel="nofollow" class="external text" href="http://db.hellground.net/?npc=21251">Underbog Collosus</a> death there's a chance that blue 'refreshing mist' is spawned. That blue cloud is supposed to regenerate health and mana. This regeneration was broken.
</p>
<h2> <span class="mw-headline" id="Step-by-step_solving">Step-by-step solving</span></h2>
<p><b>Step 0:</b> Site inspection; After appearing at the crime scene (and cursing few minutes until one collosus finally spawns blue mist) we notice that after entering it player gets <a rel="nofollow" class="external text" href="http://db.hellground.net/?spell=38730">Refreshing Mist</a> buff.
</p><p><br />
<b>Step 1:</b> Extract all info we can; Spell is casted, great, but for some reason does not heal us nor regenerate mana. We switch to combat log and see multiple entries like
<i>"<a rel="nofollow" class="external text" href="http://db.hellground.net/?npc=22335">Mushrom Spell Effect</a>'s Refreshing Mist heals us for 0"</i>. Okay, so the effect is triggered properly (buff is casted by some invisible creature, not magicaly by mist itself) but amount of health it gives is calculated wrong.
</p><p><br />
<b>Step 2:</b> Find where health gain is calculated; We get more info about spell, it creates Persistent Area Aura which periodicaly regenerates health (SPELL_AURA_OBS_MOD_HEALTH) and mana (SPELL_AURA_OBS_MOD_MANA). Each tick of peiodic aura is done inside <code>Aura::PeriodicTick()</code>, there we can find that amount of healing/regeneration (<code>pdamage</code>) is in this case equal to <code>amount</code>% of player's max HP/Mana, and basicaly <code>amount = GetModifierValue();</code>.
</p><p><br />
<b>Step 3:</b> Chasing the rabbit; Now we try to follow best shots hoping for finding something. <code>Aura::GetModifierValue()</code> function returns us <code>m_modifier.m_amount * m_stackAmount</code> which was calculated earlier. Fast search for "m_amount =" leads us to function which set this value: <code>Aura::SetModifier(...)</code>. Then we search for "SetModifier" and get to <code>Aura::Aura(...)</code>. so our <code>amount</code> is derived from the <code>damage</code> value in aura constructor.
</p><p><br />
<b>Step 4:</b> Geting back to the ground; Just before <code>Aura::SetModifier(...)</code> call we can see some debug log output, hopefuly we had debug log active while investigating crime scene (if not we turn it on now and go on hunt again). From debug log entry we get some nice info - damage is equal to 0. Okay, so this was good trace, it seems that if <code>damage</code> was equal to 10 then each of mist's ticks should give us 10% of our health. We can confirm this theory eg. by inserting just before <code>SetModifier(...)</code> lines like:
</p>
<pre>if (m_spellProto-&gt;Id == 38730)
    damage = 10;</pre>
<p>After compiling this gives us excellent result, mist is refreshing 10% of mana and HP every 2 secs!
</p><p><br />
<b>Step 5:</b> Hellgroundification; As for now we managed to "fix" stuff, now lets fix stuff. Such hacky solutions are BAD, really. We don't want to have tons of if'o'logy in our code, so its time to find proper solution. We must find why <code>damage</code> is set to 0 and fix it.
</p><p><br />
<b>Step 6:</b> Looking for damage; scrolling upwards we get to place where <code>damage</code> is calculated:
</p>
<pre style="overflow:scroll">
int32 damage;
if (currentBasePoints)
{
    damage = *currentBasePoints;
    m_currentBasePoints = damage - 1;
}else{
    m_currentBasePoints = m_spellProto-&gt;EffectBasePoints[eff];
    if (caster)
        damage = caster-&gt;CalculateSpellDamage(m_spellProto, m_effIndex, m_currentBasePoints, target);
    else
        damage = m_currentBasePoints + 1;
}
</pre>
<p>in most cases including ours <code>currentBasePoints = NULL</code> (you can believe, search for it in code or simply check using printf). <code>EffectBasePoints[eff] = 9</code> this is constant taken from spell, so it seems problem is inside <code>Unit::CalculateSpellDamage(...)</code>.
</p><p>This function calculates how spell damage is scaled by caster level. Our spell is not supposed to have random value, nor should it scale with level (what for? its 70 only instance) so most of the function have no influence in our case. By eliminating every piece that seems unimportant we get to this:
</p>
<pre style="overflow:scroll">
// hacky formula for lowlvl spells with high spelldmg after spelllevel calc
if (getLevel() &lt; 13 &amp;&amp;
    GetObjectGuid().IsCreature() &amp;&amp;
    value &gt; int32(GetMaxHealth()*0.09) &amp;&amp;
   &#160;!ToCreature()-&gt;isTrigger() &amp;&amp;
    GetEntry()&#160;!= WORLD_TRIGGER &amp;&amp;
   &#160;!(GetOwner() &amp;&amp; GetOwner()-&gt;GetTypeId() == TYPEID_PLAYER))
        value = int32(GetMaxHealth()*0.07);
</pre>
<p>Our caster npc is that <a rel="nofollow" class="external text" href="http://db.hellground.net/?npc=22335">Mushrom Spell Effect</a>, which is a creature, has low level and health, is not a trigger and does not have owner. So! in this place value is set to 0.07 of mushroom HP rounded, which is equal to 0. Bad for us. We either must increase its HP or level, so this if-clause will be skipped.
</p><p><br />
<b>Step 8:</b> Checking solution; by simple query we modify npc's level. Then we investigate everything on site again; Yay! We solved another issue, well done folks.
</p>
<h2> <span class="mw-headline" id="Summary">Summary</span></h2>
<p>Query fixing this problem:
</p>
<pre>UPDATE `creature_template` SET `minlevel` = '70', `maxlevel` = '70' WHERE `entry` = '22335'</pre>

<!-- 
NewPP limit report
Preprocessor visited node count: 92/1000000
Preprocessor generated node count: 338/1000000
Post‐expand include size: 761/2097152 bytes
Template argument size: 141/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key admin_wikia:pcache:idhash:298-0!*!0!!*!*!* and timestamp 20160412104829 -->
</div>				<!-- /bodycontent -->
								<!-- printfooter -->
				<div class="printfooter">
				Retrieved from ‘<a href="http://wiki.hellground.net/index.php?title=Tutorial:DB_460&amp;oldid=1130">http://wiki.hellground.net/index.php?title=Tutorial:DB_460&amp;oldid=1130</a>’				</div>
				<!-- /printfooter -->
												<!-- catlinks -->
				<div id='catlinks' class='catlinks'><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="Special_Categories.html" title="Special:Categories">Categories</a>: <ul><li><a href="Category_Fixing_tutorials.html" title="Category:Fixing tutorials">Fixing tutorials</a></li><li><a href="Category_Fixing_tutorials_(medium).html" title="Category:Fixing tutorials (medium)">Fixing tutorials (medium)</a></li></ul></div></div>				<!-- /catlinks -->
												<div class="visualClear"></div>
				<!-- debughtml -->
								<!-- /debughtml -->
			</div>
			<!-- /bodyContent -->
		</div>
		<!-- /content -->
		<div id="mw-navigation">
			<h2>Navigation menu</h2>
			<!-- header -->
			<div id="mw-head">
				
<!-- 0 -->
<div id="p-personal" role="navigation" class="">
	<h3>Personal tools</h3>
	<ul>
<li id="pt-login"><a href="http://wiki.hellground.net/index.php?title=Special:UserLogin&amp;returnto=Tutorial%3ADB+460" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>	</ul>
</div>

<!-- /0 -->
				<div id="left-navigation">
					
<!-- 0 -->
<div id="p-namespaces" role="navigation" class="vectorTabs">
	<h3>Namespaces</h3>
	<ul>
					<li  id="ca-nstab-main" class="selected"><span><a href="Tutorial_DB_460.html"  title="View the content page [c]" accesskey="c">Page</a></span></li>
					<li  id="ca-talk" class="new"><span><a href="http://wiki.hellground.net/index.php?title=Talk:Tutorial:DB_460&amp;action=edit&amp;redlink=1"  title="Discussion about the content page [t]" accesskey="t">Discussion</a></span></li>
			</ul>
</div>

<!-- /0 -->

<!-- 1 -->
<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet">
	<h3 id="mw-vector-current-variant">
		</h3>
	<h3><span>Variants</span><a href="#"></a></h3>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>

<!-- /1 -->
				</div>
				<div id="right-navigation">
					
<!-- 0 -->
<div id="p-views" role="navigation" class="vectorTabs">
	<h3>Views</h3>
	<ul>
					<li id="ca-view" class="selected"><span><a href="Tutorial_DB_460.html" >Read</a></span></li>
					<li id="ca-viewsource"><span><a href="http://wiki.hellground.net/index.php?title=Tutorial:DB_460&amp;action=edit"  title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span></li>
					<li id="ca-history" class="collapsible"><span><a href="http://wiki.hellground.net/index.php?title=Tutorial:DB_460&amp;action=history"  title="Past revisions of this page [h]" accesskey="h">View history</a></span></li>
			</ul>
</div>

<!-- /0 -->

<!-- 1 -->
<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet">
	<h3><span>Actions</span><a href="#"></a></h3>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>

<!-- /1 -->

<!-- 2 -->


<!-- /2 -->
				</div>
			</div>
			<!-- /header -->
			<!-- panel -->
			<div id="mw-panel">
				<!-- logo -->
					<div id="p-logo" role="banner"><a style="background-image: url(../skins/common/images/wiki.png);" href="Main_Page.html"  title="Visit the main page"></a></div>
				<!-- /logo -->
				
<!-- navigation -->
<div class="portal" role="navigation" id='p-navigation'>
	<h3>Navigation</h3>
	<div class="body">
		<ul>
			<li id="n-mainpage-description"><a href="Main_Page.html" title="Visit the main page [z]" accesskey="z">Main page</a></li>
			<li id="n-randompage"><a href="Spell_required.html" title="Load a random page [x]" accesskey="x">Random page</a></li>
		</ul>
	</div>
</div>

<!-- /navigation -->

<!-- HellGroundCore -->
<div class="portal" role="navigation" id='p-HellGroundCore'>
	<h3>HellGroundCore</h3>
	<div class="body">
		<ul>
			<li id="n-Project-site"><a href="https://hellground.net/" rel="nofollow">Project site</a></li>
			<li id="n-Project--forum"><a href="http://forum.hellground.net/" rel="nofollow">Project  forum</a></li>
			<li id="n-Project-repositories"><a href="http://emu.hellground.net/" rel="nofollow">Project repositories</a></li>
			<li id="n-Project-bug-tracker"><a href="http://forum.hellground.net/" rel="nofollow">Project bug tracker</a></li>
		</ul>
	</div>
</div>

<!-- /HellGroundCore -->

<!-- SEARCH -->

<!-- /SEARCH -->

<!-- TOOLBOX -->
<div class="portal" role="navigation" id='p-tb'>
	<h3>Tools</h3>
	<div class="body">
		<ul>
			<li id="t-whatlinkshere"><a href="Special_WhatLinksHere/Tutorial_DB_460.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
			<li id="t-recentchangeslinked"><a href="Special_RecentChangesLinked/Tutorial_DB_460.html" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
			<li id="t-specialpages"><a href="Special_SpecialPages.html" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
			<li id="t-print"><a href="http://wiki.hellground.net/index.php?title=Tutorial:DB_460&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li>
			<li id="t-permalink"><a href="http://wiki.hellground.net/index.php?title=Tutorial:DB_460&amp;oldid=1130" title="Permanent link to this revision of the page">Permanent link</a></li>
			<li id="t-info"><a href="http://wiki.hellground.net/index.php?title=Tutorial:DB_460&amp;action=info">Page information</a></li>
		</ul>
	</div>
</div>

<!-- /TOOLBOX -->

<!-- LANGUAGES -->

<!-- /LANGUAGES -->
			</div>
			<!-- /panel -->
		</div>
		<!-- footer -->
		<div id="footer" role="contentinfo">
							<ul id="footer-info">
											<li id="footer-info-lastmod"> This page was last modified on 22 May 2014, at 14:01.</li>
											<li id="footer-info-viewcount">This page has been accessed 237 times.</li>
									</ul>
							<ul id="footer-places">
											<li id="footer-places-privacy"><a href="TBC_HellGroundCore_Privacy_policy.html" title="TBC HellGroundCore:Privacy policy">Privacy policy</a></li>
											<li id="footer-places-about"><a href="TBC_HellGroundCore_About.html" title="TBC HellGroundCore:About">About HellGroundCore MMORPG framework educational and hobby project</a></li>
											<li id="footer-places-disclaimer"><a href="TBC_HellGroundCore_General_disclaimer.html" title="TBC HellGroundCore:General disclaimer">Disclaimers</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
					<li id="footer-poweredbyico">
						<a href="http://www.mediawiki.org/"><img src="../skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" width="88" height="31" /></a>
					</li>
				</ul>
						<div style="clear:both"></div>
		</div>
		<!-- /footer -->
		<script>if(window.mw){
mw.loader.state({"site":"loading","user":"missing","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.action.view.postEdit","mediawiki.user","mediawiki.page.ready","mediawiki.searchSuggest","mediawiki.hidpi","skins.vector.js"], null, true);
}</script>
<script>if(window.mw){
mw.loader.state({"site":"ready"});
}</script>
<!-- Served in 0.077 secs. -->
	</body>

<!-- Mirrored from wiki.hellground.net/index.php/Tutorial:DB_460 by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 Apr 2016 10:50:53 GMT -->
</html>
